/**
 * @file sassDirectoryImport.js
 * a grunt plugin that dynamically writes CSS @import statements from a
 * supplied file set to a single file
 *
 * @author Nate Eagle 3/30/2013
 * @see http://nateeagle.com/2013/03/30/import-a-whole-directory-with-sass-using-grunt/
 */

module.exports = function (grunt) {
  grunt.registerMultiTask(
    'sass-directory-imports',
    'Write SASS @import statements to a single file to include a directory\'s entire contents dynamically.',
    function () {
      var files = this.filesSrc;
      var quiet = this.options().quiet;
      files.forEach(function (filepath) {
        // Create an array that we'll ultimately use to populate our includes file
        var newFileContents = [
          // Header
          '// This file imports all other underscore-prefixed .scss files in this directory.',
          '// It is automatically generated by the grunt compass-directory-includes task.',
          '// Do not directly modify this file.',
          ''
        ];
        var directory = filepath.substring(0, filepath.lastIndexOf('/'));

        // Search for underscore prefixed scss files
        // Then remove the file we're writing the imports to from that set
        var filesToInclude = grunt.file.expand([directory + '/_*.scss', '!' + filepath]);

        if (!quiet) {
          grunt.log.writeln('\n' + filepath.yellow + ':');
        }

        if (!quiet && !filesToInclude.length) {
          grunt.log.writeln('No files found in ' + directory.cyan + ' to import.');
        }

        filesToInclude.forEach(function (includeFilepath) {

          // The include file is the filepath minus the directory slash and the
          // initial underscore
          var includeFile = includeFilepath.substring(includeFilepath.lastIndexOf('/') + 2);

          // Remove .scss extension
          includeFile = includeFile.replace('.scss', '');

          if (!quiet) {
            grunt.log.writeln('Importing ' + includeFile.cyan);
          }

          newFileContents.push('@import "' + includeFile + '";');
        });

        newFileContents = newFileContents.join('\n');
        grunt.file.write(filepath, newFileContents);
      });
    }
  );
};
