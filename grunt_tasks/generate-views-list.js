/**
 * @file generate-views-list
 * a grunt plugin that dynamically writes to _views.js
 *
 * @author Justin Helmer 09/18/2013
 */

module.exports = function (grunt) {
  'use strict';

  var config = require('../grunt-config.js');

  grunt.registerMultiTask(
    'generate-views-list',
    'dynamically writes to _views.js with a list of all views except base views',
    function () {
      var files = this.filesSrc;
      var outputFile = this.options().outputFile;

      if (!files.length) {
        grunt.log.writeln('\nNo files found to import.');
      }

      grunt.log.writeln('\nWriting to ' + outputFile.yellow + ':');

      var lines = [
        // Header
        '// This variable `list` is automatically generated by the grunt generate-views-list task.',
        '// Do not directly modify.',
        '',
        'var list = ['
      ];

      files.forEach(function (filepath) {
        // Strip out beginning of filepath and extension
        var requirePath = filepath.replace(/^.*(views(\/\w+)?\/\w+)\.js$/, '$1');

        // Write requirePath to file
        grunt.log.writeln('Importing ' + requirePath.cyan);
        lines.push('  \'' + requirePath + '\',');
      });

      // Close list array
      lines.push('];\n');

      // Turn array of lines into single string, and write to file
      grunt.file.write(outputFile, lines.join('\n'));
    }
  );
};
